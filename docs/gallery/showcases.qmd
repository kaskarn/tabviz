---
title: "Feature Showcases"
---

```{r}
#| include: false
library(tabviz)
library(dplyr)
```

Demonstrations of specific tabviz features.

## Column Groups

Organize columns under hierarchical headers:

```{r}
data(glp1_trials)

tabviz(
  glp1_trials |> filter(row_type == "data"),
  label = "study",
  columns = list(
    col_group("Study Info",
      col_text("drug", "Drug"),
      col_n("n")
    ),
    col_forest(point = "hr", lower = "lower", upper = "upper",
               scale = "log", null_value = 1),
    col_group("Results",
      col_interval("HR (95% CI)", point = "hr", lower = "lower", upper = "upper"),
      col_pvalue("pvalue", "P")
    )
  ),
  theme = web_theme_nature(),
  title = "Column Groups Example"
)
```

## Collapsible Row Groups

Hierarchical grouping with expand/collapse:

```{r}
grouped_data <- data.frame(
  study = c("Trial A", "Trial B", "Trial C", "Trial D",
            "Trial E", "Trial F", "Trial G", "Trial H"),
  category = c("Drug X", "Drug X", "Drug X", "Drug X",
               "Drug Y", "Drug Y", "Drug Y", "Drug Y"),
  subcategory = c("High Dose", "High Dose", "Low Dose", "Low Dose",
                  "High Dose", "High Dose", "Low Dose", "Low Dose"),
  hr = c(0.72, 0.78, 0.85, 0.88, 0.65, 0.71, 0.82, 0.86),
  lo = c(0.55, 0.62, 0.70, 0.72, 0.50, 0.55, 0.68, 0.70),
  hi = c(0.95, 0.98, 1.03, 1.08, 0.85, 0.92, 0.99, 1.06)
)

tabviz(grouped_data,
  label = "study",
  group = c("category", "subcategory"),
  columns = list(
    col_forest(point = "hr", lower = "lo", upper = "hi",
               scale = "log", null_value = 1),
    col_interval("HR (95% CI)", point = "hr", lower = "lo", upper = "hi")
  ),
  theme = web_theme_modern(),
  title = "Nested Grouping"
)
```

## All Theme Variants

Compare all 9 built-in themes:

```{r}
#| layout-ncol: 3
#| fig-height: 2.5

sample_data <- data.frame(
  study = c("A", "B", "C"),
  hr = c(0.72, 0.85, 0.91),
  lo = c(0.55, 0.70, 0.75),
  hi = c(0.95, 1.03, 1.10)
)

make_plot <- function(theme_fn, name) {
  tabviz(sample_data, label = "study",
    columns = list(col_forest(point = "hr", lower = "lo", upper = "hi",
                             scale = "log", null_value = 1)),
    theme = theme_fn(), title = name
  )
}

make_plot(web_theme_default, "Default")
make_plot(web_theme_jama, "JAMA")
make_plot(web_theme_lancet, "Lancet")
make_plot(web_theme_nature, "Nature")
make_plot(web_theme_cochrane, "Cochrane")
make_plot(web_theme_modern, "Modern")
make_plot(web_theme_presentation, "Presentation")
make_plot(web_theme_dark, "Dark")
make_plot(web_theme_minimal, "Minimal")
```

## Reference Lines and Annotations

Custom annotations on forest plots:

```{r}
tabviz(
  glp1_trials |> filter(row_type == "data"),
  label = "study",
  columns = list(
    col_forest(point = "hr", lower = "lower", upper = "upper",
               scale = "log", null_value = 1,
               axis_gridlines = TRUE)
  ),
  annotations = list(
    forest_refline(1, label = "No effect", style = "solid"),
    forest_refline(0.85, label = "Pooled estimate", style = "dashed", color = "#2563eb"),
    forest_refline(0.75, label = "Clinical threshold", style = "dotted", color = "#dc2626")
  ),
  theme = web_theme_minimal(),
  title = "Reference Lines"
)
```

## Cell-Level Styling

Conditional formatting per cell:

```{r}
cell_data <- data.frame(
  study = c("Trial A", "Trial B", "Trial C", "Trial D", "Trial E"),
  hr = c(0.65, 0.78, 0.95, 1.12, 0.72),
  pval = c(0.001, 0.02, 0.15, 0.03, 0.008),
  quality = c("High", "Medium", "Low", "High", "Medium")
)

tabviz(cell_data,
  label = "study",
  columns = list(
    col_numeric("hr", "HR",
      color = ~ ifelse(.x < 1, "#16a34a", "#dc2626"),
      bold = ~ .x < 0.8 | .x > 1.1
    ),
    col_pvalue("pval",
      stars = TRUE,
      bold = ~ .x < 0.05
    ),
    col_badge("quality")
  ),
  theme = web_theme_modern(),
  title = "Cell-Level Formatting"
)
```

## Marker Customization

Different shapes and colors per row:

```{r}
marker_data <- data.frame(
  study = c("RCT A", "RCT B", "Observational C", "Observational D", "Registry E"),
  hr = c(0.72, 0.85, 0.78, 0.91, 0.88),
  lo = c(0.55, 0.70, 0.62, 0.78, 0.75),
  hi = c(0.95, 1.03, 0.98, 1.06, 1.03),
  design = c("RCT", "RCT", "Cohort", "Cohort", "Registry"),
  quality = c(1, 0.9, 0.7, 0.6, 0.5)
)

tabviz(marker_data,
  label = "study",
  columns = list(
    col_text("design", "Design"),
    col_forest(point = "hr", lower = "lo", upper = "hi",
               scale = "log", null_value = 1)
  ),
  marker_shape = ~ case_when(
    design == "RCT" ~ "circle",
    design == "Cohort" ~ "square",
    TRUE ~ "diamond"
  ),
  marker_color = ~ case_when(
    hi < 1 ~ "#16a34a",
    lo > 1 ~ "#dc2626",
    TRUE ~ "#64748b"
  ),
  marker_opacity = "quality",
  marker_size = ~ ifelse(design == "RCT", 1.2, 1),
  theme = web_theme_nature(),
  title = "Marker Customization"
)
```

## Row Banding

Alternating row backgrounds for readability:

```{r}
set.seed(42)  # For reproducible random data
banding_data <- data.frame(
  study = paste0("Study ", LETTERS[1:10]),
  hr = runif(10, 0.6, 1.2),
  lo = runif(10, 0.4, 0.8),
  hi = runif(10, 1.0, 1.5),
  row_num = 1:10  # Pre-compute row numbers
)

tabviz(banding_data,
  label = "study",
  columns = list(
    col_forest(point = "hr", lower = "lo", upper = "hi",
               scale = "log", null_value = 1),
    col_interval("HR (95% CI)", point = "hr", lower = "lo", upper = "hi")
  ),
  row_bg = ~ ifelse(row_num %% 2 == 0, "#f8fafc", NA_character_),
  theme = web_theme_minimal(),
  title = "Row Banding"
)
```
